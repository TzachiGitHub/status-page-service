generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ─── Enums ───────────────────────────────────────────────

enum MemberRole {
  OWNER
  ADMIN
  EDITOR
  VIEWER
}

enum MonitorType {
  HTTP
  TCP
  PING
  DNS
  SSL
  HEARTBEAT
}

enum MonitorStatus {
  UP
  DOWN
  DEGRADED
  UNKNOWN
}

enum HttpMethod {
  GET
  POST
  PUT
  PATCH
  DELETE
  HEAD
  OPTIONS
}

enum ComponentStatus {
  OPERATIONAL
  DEGRADED_PERFORMANCE
  PARTIAL_OUTAGE
  MAJOR_OUTAGE
  UNDER_MAINTENANCE
}

enum IncidentStatus {
  INVESTIGATING
  IDENTIFIED
  MONITORING
  RESOLVED
}

enum IncidentSeverity {
  MINOR
  MAJOR
  CRITICAL
}

enum SubscriberType {
  EMAIL
  WEBHOOK
  SLACK
}

enum AlertStatus {
  PENDING
  SENT
  FAILED
}

enum NotificationChannelType {
  EMAIL
  SLACK
  WEBHOOK
  SMS
}

enum KeywordType {
  CONTAINS
  NOT_CONTAINS
}

// ─── Models ──────────────────────────────────────────────

model Organization {
  id        String   @id @default(uuid())
  name      String
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  members              Member[]
  monitors             Monitor[]
  components           Component[]
  componentGroups      ComponentGroup[]
  incidents            Incident[]
  subscribers          Subscriber[]
  notificationChannels NotificationChannel[]
  apiKeys              ApiKey[]
  statusPageConfig     StatusPageConfig?

  @@map("organizations")
}

model Member {
  id        String     @id @default(uuid())
  email     String
  password  String
  name      String
  role      MemberRole @default(VIEWER)
  orgId     String
  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@unique([email])
  @@index([orgId])
  @@map("members")
}

model Monitor {
  id                 String        @id @default(uuid())
  name               String
  type               MonitorType
  url                String?
  target             String?
  method             HttpMethod    @default(GET)
  interval           Int           @default(60)
  timeout            Int           @default(30)
  status             MonitorStatus @default(UNKNOWN)
  currentStatus      String        @default("UNKNOWN")
  enabled            Boolean       @default(true)
  orgId              String
  componentId        String?
  headers            Json?
  body               String?
  expectedStatus     Int?
  keyword            String?
  keywordType        KeywordType?
  heartbeatToken     String?       @unique
  heartbeatGrace     Int?          @default(300)
  sslExpiryThreshold Int?          @default(30)
  alertAfter         Int           @default(3)
  recoveryAfter      Int           @default(2)
  lastCheckedAt      DateTime?
  uptimeDay          Float?
  uptimeWeek         Float?
  uptimeMonth        Float?
  avgResponseTime    Float?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  organization Organization   @relation(fields: [orgId], references: [id], onDelete: Cascade)
  component    Component?     @relation(fields: [componentId], references: [id], onDelete: SetNull)
  checks       MonitorCheck[]
  alerts       MonitorAlert[]

  @@index([orgId])
  @@index([status])
  @@map("monitors")
}

model MonitorCheck {
  id           String        @id @default(uuid())
  monitorId    String
  status       MonitorStatus
  responseTime Int?
  statusCode   Int?
  message      String?
  error        String?
  region       String?
  checkedAt    DateTime      @default(now())

  monitor Monitor @relation(fields: [monitorId], references: [id], onDelete: Cascade)

  @@index([monitorId, checkedAt])
  @@map("monitor_checks")
}

model MonitorAlert {
  id        String   @id @default(uuid())
  monitorId String
  type      String
  message   String
  createdAt DateTime @default(now())

  monitor Monitor @relation(fields: [monitorId], references: [id], onDelete: Cascade)

  @@index([monitorId])
  @@map("monitor_alerts")
}

model ComponentGroup {
  id        String   @id @default(uuid())
  name      String
  order     Int      @default(0)
  orgId     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  components   Component[]

  @@index([orgId])
  @@map("component_groups")
}

model Component {
  id          String          @id @default(uuid())
  name        String
  description String?
  status      ComponentStatus @default(OPERATIONAL)
  order       Int             @default(0)
  orgId       String
  groupId     String?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  organization Organization        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  group        ComponentGroup?     @relation(fields: [groupId], references: [id], onDelete: SetNull)
  monitors     Monitor[]
  incidents    IncidentComponent[]

  @@index([orgId])
  @@map("components")
}

model Incident {
  id         String           @id @default(uuid())
  title      String
  status     IncidentStatus   @default(INVESTIGATING)
  severity   IncidentSeverity @default(MINOR)
  orgId      String
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt
  resolvedAt DateTime?

  organization Organization        @relation(fields: [orgId], references: [id], onDelete: Cascade)
  updates      IncidentUpdate[]
  components   IncidentComponent[]

  @@index([orgId])
  @@index([status])
  @@map("incidents")
}

model IncidentUpdate {
  id         String         @id @default(uuid())
  incidentId String
  status     IncidentStatus
  message    String
  createdAt  DateTime       @default(now())

  incident Incident @relation(fields: [incidentId], references: [id], onDelete: Cascade)

  @@index([incidentId])
  @@map("incident_updates")
}

model IncidentComponent {
  id          String          @id @default(uuid())
  incidentId  String
  componentId String
  status      ComponentStatus

  incident  Incident  @relation(fields: [incidentId], references: [id], onDelete: Cascade)
  component Component @relation(fields: [componentId], references: [id], onDelete: Cascade)

  @@unique([incidentId, componentId])
  @@map("incident_components")
}

model Subscriber {
  id         String         @id @default(uuid())
  type       SubscriberType @default(EMAIL)
  email      String?
  webhookUrl String?
  confirmed  Boolean        @default(false)
  token      String         @unique @default(uuid())
  orgId      String
  createdAt  DateTime       @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)
  alerts       Alert[]

  @@index([orgId])
  @@map("subscribers")
}

model Alert {
  id           String      @id @default(uuid())
  subscriberId String
  incidentId   String?
  subject      String
  body         String
  status       AlertStatus @default(PENDING)
  sentAt       DateTime?
  createdAt    DateTime    @default(now())

  subscriber Subscriber @relation(fields: [subscriberId], references: [id], onDelete: Cascade)

  @@index([subscriberId])
  @@map("alerts")
}

model NotificationChannel {
  id        String                  @id @default(uuid())
  name      String
  type      NotificationChannelType
  config    Json
  enabled   Boolean                 @default(true)
  orgId     String
  createdAt DateTime                @default(now())
  updatedAt DateTime                @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@map("notification_channels")
}

model ApiKey {
  id         String    @id @default(uuid())
  name       String
  key        String    @unique
  orgId      String
  expiresAt  DateTime?
  lastUsedAt DateTime?
  createdAt  DateTime  @default(now())

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@index([orgId])
  @@index([key])
  @@map("api_keys")
}

model StatusPageConfig {
  id               String   @id @default(uuid())
  orgId            String   @unique
  title            String
  description      String?
  logoUrl          String?
  faviconUrl       String?
  customDomain     String?
  customCss        String?
  showUptime       Boolean  @default(true)
  showResponseTime Boolean  @default(true)
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  organization Organization @relation(fields: [orgId], references: [id], onDelete: Cascade)

  @@map("status_page_configs")
}
